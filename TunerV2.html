<!DOCTYPE html>

<html>

<head>
  <title>TD</title>

  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      margin: 0;
      background-color: #f4f4f4;
      font-family: 'Arial', sans-serif;
    }

    .chart-container {
      width: 80vw;
      height: 70vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .freq-container {
      width: 80vw;
      height: 8vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      display: block;
    }

    h1 {
      color: #2f8d46;
      text-align: center;
      margin-bottom: 15px;
    }
  </style>

</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/aubiojs@0.1.1/build/aubio.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div>
    <h1>Tuner Turkish Makam Scale</h1>
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>

    <div class="freq-container">
      <label id="lb1">Cents above C4</label>
    </div>
  </div>

  <script>

    const lbfreq = document.getElementById('lb1');

    const Tuner = function () {
      this.bufferSize = 4096;
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
    };

    Tuner.prototype.init = function () {
      console.log('Tuner Initialized')
      this.audioContext = new window.AudioContext();
      this.analyser = this.audioContext.createAnalyser();
      this.scriptProcessor = this.audioContext.createScriptProcessor(this.bufferSize, 1, 1);

      const self = this;

      aubio().then(function (aubio) {
        self.pitchDetector = new aubio.Pitch("default", self.bufferSize, 1, self.audioContext.sampleRate);
        self.startRecord();
      });
    };

    Tuner.prototype.startRecord = function () {
      console.log('Record Starting')
      const self = this;
      navigator.mediaDevices
        .getUserMedia({ audio: true })
        .then(function (stream) {
          self.audioContext.createMediaStreamSource(stream).connect(self.analyser);
          self.analyser.connect(self.scriptProcessor);
          self.scriptProcessor.connect(self.audioContext.destination);
          self.scriptProcessor.addEventListener("audioprocess", function (event) {

            const frequency = self.pitchDetector.do(
              event.inputBuffer.getChannelData(0)
            );

            if (frequency) {
              console.log(frequency)
              removeData(myChart)
              const newData = 1200 * Math.log2(frequency / 261.626);
              addData(myChart, '', newData);
              lbfreq.innerText = "Cents above C4: " + Math.round(newData);
            }
          });
        });
    };

    const Application = function () {
      this.tuner = new Tuner();
    };

    Application.prototype.start = function () {
      console.log('Start Application')
      const self = this;
      self.tuner.init();
    };

    const app = new Application();
    app.start();
    const canvas = document.getElementById('myChart');

    const labels = [''];

    const data = {
      labels: labels,
      datasets: [{
        label: '',
        data: [0],
      }]
    };

    const names = [
'Kaba Çârgâh (C4) - 0',
'Kaba Nim Hicâz (C4 + 4) - 4                                                                ',
'Kaba Hicâz (C4 + 5) - 5                                                                                                                                ',
'Kaba Dik Hicâz (C4 + 8) - 8                                                                                                                                                                                                ',
'Yegâh (D4) - 9',
'Kaba Nim Hisâr (D4 + 4) - 13                                                                ',
'Kaba Hisâr (D4 + 5) - 14                                                                                                                                ',
'Kaba Dik Hisâr (D4 + 8) - 17                                                                                                                                                                                                ',
'Hüseynî Aşîrân (E4) - 18',
'Acem Aşîrân (F4) - 22',
'Dik Acem Aşîrân (F4 + 1) - 23    ',
'Irak (F4 + 4) - 26                                                                ',
'Gevest (F4 + 5) - 27                                                                                                                                ',
'Dik Gevest (F4 + 8) - 30                                                                                                                                                                                                ',
'Rast (G4) - 31',
'Nim Zirgüle (G4 + 4) - 35                                                                ',
'Zirgüle (G4 + 5) - 36                                                                                                                                ',
'Dik Zirgüle (G4 + 8) - 39                                                                                                                                                                                                ',
'Dügâh (A4) - 40',
'Kürdi (A4 + 4) - 44                                                                ',
'Dik Kürdi (A4 + 5) - 45                                                                                                                                ',
'Segâh (A4 + 8) - 48                                                                                                                                                                                                ',
'Bûselik (B4) - 49',
'Dik Bûselik (B4 + 3) - 52                                                                ',
'Çârgâh (C5) - 53',
'Nim Hicâz (C5 + 4) - 57                                                                ',
'Hicâz (C5 + 5) - 58                                                                                                                                ',
'Dik Hicâz (C5 + 8) - 61                                                                                                                                                                                                ',
'Nevâ (D5) - 62',
'Nim Hisâr (D5 + 4) - 66                                                                ',
'Hisâr (D5 + 5) - 67                                                                                                                                ',
'Dik Hisâr (D5 + 8) - 70                                                                                                                                                                                                ',
'Hüseynî (E5) - 71',
'Acem (F5) - 75',
'Dik Acem (F5 + 1) - 76    ',
'Eviç (F5 + 4) - 79                                                                ',
'Mâhûr (F5 + 5) - 80                                                                                                                                ',
'Dik Mâhûr (F5 + 8) - 83                                                                                                                                                                                                ',
'Gerdâniye (G5) - 84',
'Nim Şehnâz (G5 + 4) - 88                                                                ',
'Şehnâz (G5 + 5) - 89                                                                                                                                ',
'Dik Şehnâz (G5 + 8) - 92                                                                                                                                                                                                ',
'Muhayyer (A5) - 93',
'Sünbüle (A5 + 4) - 97                                                                ',
'Dik Sünbüle (A5 + 5) - 98                                                                                                                                ',
'Tîz Segâh (A5 + 8) - 101                                                                                                                                                                                                ',
'Tîz Bûselik (B5) - 102',
'Tîz Dik Bûselik (B5 + 3) - 105                                                                ',
'Tîz Çârgâh (C6) - 106'
]


    const config = {
      type: 'bar',
      data: data,
      options: {
        scales: {
          y: {
            min: 0,
            max: 2400,
            afterBuildTicks: axis => axis.ticks = [0,91,113,181,204,294,317,385,408,498,521,589,611,679,702,
                792,815,883,906,996,1019,1087,1109,1177,1200,
                1291,1313,1381,1404,1494,1517,1585,1608,1698,1721,
                1789,1811,1879,1902,1992,2015,2083,2106,2196,2219,2287,2309,
                2377,2400].map(v => ({ value: v })),
            ticks: {
              autoSkip: false,
                font: {
                  size: 9,
                },
                // Include a dollar sign in the ticks
                callback: function(value, index, ticks) {
                    return names[index];
                }
             },

            grid: {
              color: ['#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#283747',
'#b7950b',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#b7950b',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#283747',
'#b7950b',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#2e86c1',
'#239b56',
'#a04000',
'#283747',
'#b7950b',
'#283747']
            },

            }
        },
        aspectRatio: 2,
        plugins:{
          legend: {
            display: false
         }},
      }
      
    };

    const myChart = new Chart(
      canvas,
      config
    );

    function removeData(chart) {
      chart.data.labels.pop();
      chart.data.datasets.forEach((dataset) => {
        dataset.data.pop();
      });
      chart.update('none');
    }

    function addData(chart, label, newData) {
      chart.data.labels.push(label);
      chart.data.datasets.forEach((dataset) => {
        dataset.data.push(newData);
      });
      chart.update('none');
    }

  </script>
</body>

</html>