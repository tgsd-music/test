<!DOCTYPE html>

<html>

<head>
  <title>TD</title>

  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      margin: 0;
      background-color: #f4f4f4;
      font-family: 'Arial', sans-serif;
    }

    .chart-container {
      width: 90vw;
      height: 68vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .freq-container {
      width: 90vw;
      height: 3vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      display: block;
    }

    h1 {
      color: #2f8d46;
      text-align: center;
      margin-bottom: 15px;
    }
  </style>

</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/aubiojs@0.1.1/build/aubio.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div>
    <h1>Tuner Turkish Makam Scale</h1>
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>

    <div class="freq-container">
      <label id="lb1">Cents above C4</label>
    </div>
  </div>

  <script>

    const lbfreq = document.getElementById('lb1');

    const Tuner = function () {
      this.bufferSize = 4096;
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
    };

    Tuner.prototype.init = function () {
      console.log('Tuner Initialized')
      this.audioContext = new window.AudioContext();
      this.analyser = this.audioContext.createAnalyser();
      this.scriptProcessor = this.audioContext.createScriptProcessor(this.bufferSize, 1, 1);

      const self = this;

      aubio().then(function (aubio) {
        self.pitchDetector = new aubio.Pitch("default", self.bufferSize, 1, self.audioContext.sampleRate);
        self.startRecord();
      });
    };

    Tuner.prototype.startRecord = function () {
      console.log('Record Starting')
      const self = this;
      navigator.mediaDevices
        .getUserMedia({ audio: true })
        .then(function (stream) {
          self.audioContext.createMediaStreamSource(stream).connect(self.analyser);
          self.analyser.connect(self.scriptProcessor);
          self.scriptProcessor.connect(self.audioContext.destination);
          self.scriptProcessor.addEventListener("audioprocess", function (event) {

            const frequency = self.pitchDetector.do(
              event.inputBuffer.getChannelData(0)
            );

            if (frequency) {
              //console.log(frequency)
			  
			  //261.626
              removeData(myChart)
              const cents = 1200 * Math.log2(frequency / 60);
              addData(myChart, '', cents);
			  
              NearNote(cents);
            }
          });
        });
    };
	

    const Application = function () {
      this.tuner = new Tuner();
    };

    Application.prototype.start = function () {
      console.log('Start Application')
      const self = this;
      self.tuner.init();
    };

    const app = new Application();
    app.start();
    const canvas = document.getElementById('myChart');

    const labels = [''];

    const data = {
      labels: labels,
      datasets: [{
        label: '',
        data: [0],
      }]
    };

    const names = [
		'Kaba Cargah (C4) - 0',
		'Kaba Nim Hicaz (C4 + 4) - 91              ',
		'Kaba Hicaz (C4 + 5) - 113                                                                        ',
		'Kaba Dik Hicaz (C4 + 8) - 181                                                                                                            ',
		'Yegah (D4) - 204',
		'Kaba Nim Hisar (D4 + 4) - 294             ',
		'Kaba Hisar (D4 + 5) - 317                                                                        ',
		'Kaba Dik Hisar (D4 + 8) - 385                                                                                                            ',
		'Huseyni Asiran (E4) - 408',
		'Acem Asiran (F4) - 498',
		'Dik Acem Asiran (F4 + 1) - 521                                          ',
		'Irak (F4 + 4) - 589                                    ',
		'Gevest (F4 + 5) - 611                                                                        ',
		'Dik Gevest (F4 + 8) - 679                                                                                                            ',
		'Rast (G4) - 702',
		'Nim Zirgule (G4 + 4) - 792                                    ',
		'Zirgule (G4 + 5) - 815                                                                        ',
		'Dik Zirgule (G4 + 8) - 39                                                                                                            ',
		'Dugah (A4) - 40',
		'Kurdi (A4 + 4) - 44                                    ',
		'Dik Kurdi (A4 + 5) - 45                                                                        ',
		'Segah (A4 + 8) - 48                                                                                                            ',
		'Buselik (B4) - 49',
		'Dik Buselik (B4 + 3) - 52                                    ',
		'Cargah (C5) - 53',
		'Nim Hicaz (C5 + 4) - 57                                    ',
		'Hicaz (C5 + 5) - 58                                                                        ',
		'Dik Hicaz (C5 + 8) - 61                                                                                                            ',
		'Neva (D5) - 62',
		'Nim Hisar (D5 + 4) - 66                                    ',
		'Hisar (D5 + 5) - 67                                                                        ',
		'Dik Hisar (D5 + 8) - 70                                                                                                            ',
		'Huseyni (E5) - 71',
		'Acem (F5) - 75',
		'Dik Acem (F5 + 1) - 76                                                ',
		'EviC (F5 + 4) - 79                                    ',
		'Mahur (F5 + 5) - 80                                                                        ',
		'Dik Mahur (F5 + 8) - 83                                                                                                            ',
		'Gerdaniye (G5) - 84',
		'Nim sehnaz (G5 + 4) - 88                                    ',
		'sehnaz (G5 + 5) - 89                                                                        ',
		'Dik sehnaz (G5 + 8) - 92                                                                                                            ',
		'Muhayyer (A5) - 93',
		'Sunbule (A5 + 4) - 97                                    ',
		'Dik Sunbule (A5 + 5) - 98                                                                        ',
		'Tiz Segah (A5 + 8) - 101                                                                                                            ',
		'Tiz Buselik (B5) - 102',
		'Tiz Dik Buselik (B5 + 3) - 105                                    ',
		'Tiz Cargah (C6) - 106'
	]

    const names2 = [
		'Kaba Cargah (C4) - 0',
		'Kaba Nim Hicaz (C4 + 4) - 91',
		'Kaba Hicaz (C4 + 5) - 113',
		'Kaba Dik Hicaz (C4 + 8) - 181',
		'Yegah (D4) - 204',
		'Kaba Nim Hisar (D4 + 4) - 294',
		'Kaba Hisar (D4 + 5) - 317',
		'Kaba Dik Hisar (D4 + 8) - 385',
		'Huseyni Asiran (E4) - 408',
		'Acem Asiran (F4) - 498',
		'Dik Acem Asiran (F4 + 1) - 521',
		'Irak (F4 + 4) - 589',
		'Gevest (F4 + 5) - 611',
		'Dik Gevest (F4 + 8) - 679',
		'Rast (G4) - 702',
		'Nim Zirgule (G4 + 4) - 792',
		'Zirgule (G4 + 5) - 815',
		'Dik Zirgule (G4 + 8) - 883',
		'Dugah (A4) - 906',
		'Kurdi (A4 + 4) - 996',
		'Dik Kurdi (A4 + 5) - 1019',
		'Segah (A4 + 8) - 1087',
		'Buselik (B4) - 1109',
		'Dik Buselik (B4 + 3) - 1177',
		'Cargah (C5) - 1200',
		'Nim Hicaz (C5 + 4) - 1291',
		'Hicaz (C5 + 5) - 1313',
		'Dik Hicaz (C5 + 8) - 1381',
		'Neva (D5) - 1404',
		'Nim Hisar (D5 + 4) - 1494',
		'Hisar (D5 + 5) - 1517',
		'Dik Hisar (D5 + 8) - 1585',
		'Huseyni (E5) - 1608',
		'Acem (F5) - 1698',
		'Dik Acem (F5 + 1) - 1721',
		'EviC (F5 + 4) - 1789',
		'Mahur (F5 + 5) - 1811',
		'Dik Mahur (F5 + 8) - 1879',
		'Gerdaniye (G5) - 1902',
		'Nim sehnaz (G5 + 4) - 1992',
		'sehnaz (G5 + 5) - 2015',
		'Dik sehnaz (G5 + 8) - 2083',
		'Muhayyer (A5) - 2106',
		'Sunbule (A5 + 4) - 2196',
		'Dik Sunbule (A5 + 5) - 2219',
		'Tiz Segah (A5 + 8) - 2287',
		'Tiz Buselik (B5) - 2309',
		'Tiz Dik Buselik (B5 + 3) - 2377',
		'Tiz Cargah (C6) - 2400'
	]
	
	const values = [0,91,113,181,204,294,317,385,408,498,521,589,611,679,702,
                792,815,883,906,996,1019,1087,1109,1177,1200,
                1291,1313,1381,1404,1494,1517,1585,1608,1698,1721,
                1789,1811,1879,1902,1992,2015,2083,2106,2196,2219,2287,2309,
                2377,2400]

	const NearNote = function (cents){
		if (cents>0 && cents<2400){
		for (var i = 0; i < names.length; i++) {
			if (values[i]>cents){
				break;
			};
		};
		const low = Math.abs(values[i-1]-cents)
		const high = Math.abs(values[i]-cents)
		if (low>high){
			console.log(Math.round(cents) + ' | '  + names2[i] + ' | ' + Math.round(values[i]-cents))
			lbfreq.innerText = Math.round(cents) + ' | '  + names2[i] + ' | ' + Math.round(values[i]-cents)
		} else {
			console.log(Math.round(cents) + ' | '  + names2[i-1] + '|' + Math.round(values[i-1]-cents))
			lbfreq.innerText = Math.round(cents) + ' | '  + names2[i-1] + '|' + Math.round(values[i-1]-cents)
		};

		};
		
	};
	
    const config = {
      type: 'bar',
      data: data,
      options: {
        scales: {
          y: {
            min: 0,
            max: 2400,
            afterBuildTicks: axis => axis.ticks = [0,91,113,181,204,294,317,385,408,498,521,589,611,679,702,
                792,815,883,906,996,1019,1087,1109,1177,1200,
                1291,1313,1381,1404,1494,1517,1585,1608,1698,1721,
                1789,1811,1879,1902,1992,2015,2083,2106,2196,2219,2287,2309,
                2377,2400].map(v => ({ value: v })),
            ticks: {
              autoSkip: false,
                font: {
                  size: 12,
                },
                
                callback: function(value, index, ticks) {
                    return names[index];
                }
             },

            grid: {
              color: ['#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#283747',
						'#b7950b',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#b7950b',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#283747',
						'#b7950b',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#2e86c1',
						'#239b56',
						'#a04000',
						'#283747',
						'#b7950b',
						'#283747']
            },

            }
        },
        aspectRatio: 2,
        plugins:{
          legend: {
            display: false
         }},
		responsive: true 
      }
      
    };

    const myChart = new Chart(
      canvas,
      config
    );

    function removeData(chart) {
      chart.data.labels.pop();
      chart.data.datasets.forEach((dataset) => {
        dataset.data.pop();
      });
      chart.update('none');
    }

    function addData(chart, label, newData) {
      chart.data.labels.push(label);
      chart.data.datasets.forEach((dataset) => {
        dataset.data.push(newData);
      });
      chart.update('none');
    }

  </script>
</body>

</html>