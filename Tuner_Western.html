<!DOCTYPE html>

<html>

<head>
  <title>TD</title>

  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      margin: 0;
      background-color: #f4f4f4;
      font-family: 'Arial', sans-serif;
    }

    .chart-container {
      width: 80vw;
      height: 70vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .freq-container {
      width: 80vw;
      height: 8vh;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    canvas {
      display: block;
    }

    h1 {
      color: #2f8d46;
      text-align: center;
      margin-bottom: 15px;
    }
  </style>

</head>

<body>
  <script src="https://cdn.jsdelivr.net/npm/aubiojs@0.1.1/build/aubio.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <div>
    <h1>Tuner Western Scale</h1>
    <div class="chart-container">
      <canvas id="myChart"></canvas>
    </div>

    <div class="freq-container">
      <label id="lb1">Cents above C4</label>
    </div>
  </div>

  <script>

    const lbfreq = document.getElementById('lb1');

    const Tuner = function () {
      this.bufferSize = 4096;
      window.AudioContext = window.AudioContext || window.webkitAudioContext;
    };

    Tuner.prototype.init = function () {
      console.log('Tuner Initialized')
      this.audioContext = new window.AudioContext();
      this.analyser = this.audioContext.createAnalyser();
      this.scriptProcessor = this.audioContext.createScriptProcessor(this.bufferSize, 1, 1);

      const self = this;

      aubio().then(function (aubio) {
        self.pitchDetector = new aubio.Pitch("default", self.bufferSize, 1, self.audioContext.sampleRate);
        self.startRecord();
      });
    };

    Tuner.prototype.startRecord = function () {
      console.log('Record Starting')
      const self = this;
      navigator.mediaDevices
        .getUserMedia({ audio: true })
        .then(function (stream) {
          self.audioContext.createMediaStreamSource(stream).connect(self.analyser);
          self.analyser.connect(self.scriptProcessor);
          self.scriptProcessor.connect(self.audioContext.destination);
          self.scriptProcessor.addEventListener("audioprocess", function (event) {

            const frequency = self.pitchDetector.do(
              event.inputBuffer.getChannelData(0)
            );

            if (frequency) {
              console.log(frequency)
              removeData(myChart)
              const newData = 1200 * Math.log2(frequency / 261.626);
              addData(myChart, '', newData);
              lbfreq.innerText = "Cents above C4: " + Math.round(newData);
            }
          });
        });
    };

    const Application = function () {
      this.tuner = new Tuner();
    };

    Application.prototype.start = function () {
      console.log('Start Application')
      const self = this;
      self.tuner.init();
    };

    const app = new Application();
    app.start();
    const canvas = document.getElementById('myChart');

    const labels = [''];

    const data = {
      labels: labels,
      datasets: [{
        label: '',
        data: [0],
      }]
    };

    const names = ['C4 - 0',
                    'C#4 - 100        ',
                    'D4 - 200',
                    'D#4 - 300        ',
                    'E4 - 400',
                    'F4 - 500',
                    'F#4 - 600        ',
                    'G4 - 700',
                    'G#4 - 800        ',
                    'A4 - 900',
                    'A#4 - 1000        ',
                    'B4 - 1100',
                    'C5 - 1200',
                    'C#5 - 1300        ',
                    'D5 - 1400',
                    'D#5 - 1500        ',
                    'E5 - 1600',
                    'F5 - 1700',
                    'F#5 - 1800        ',
                    'G5 - 1900',
                    'G#5 - 2000        ',
                    'A5 - 2100',
                    'A#5 - 2200        ',
                    'B5 - 2300',
                    'C6 - 2400']


    const config = {
      type: 'bar',
      data: data,
      options: {
        scales: {
          y: {
            min: 0,
            max: 2400,
            afterBuildTicks: axis => axis.ticks = [0,
                                                  100,
                                                  200,
                                                  300,
                                                  400,
                                                  500,
                                                  600,
                                                  700,
                                                  800,
                                                  900,
                                                  1000,
                                                  1100,
                                                  1200,
                                                  1300,
                                                  1400,
                                                  1500,
                                                  1600,
                                                  1700,
                                                  1800,
                                                  1900,
                                                  2000,
                                                  2100,
                                                  2200,
                                                  2300,
                                                  2400].map(v => ({ value: v })),
                                                  ticks: {
              autoSkip: false,
                font: {
                  size: 9,
                },
                // Include a dollar sign in the ticks
                callback: function(value, index, ticks) {
                    return names[index];
                }
             },

            grid: {
              color: ['#283747',
                      '#ee391c',
                      '#283747',
                      '#ee391c',
                      '#283747',
                      '#283747',
                      '#ee391c',
                      '#283749',
                      '#ee391c',
                      '#283751',
                      '#ee391c',
                      '#283753',
                      '#283754',
                      '#ee391c',
                      '#283756',
                      '#ee391c',
                      '#283758',
                      '#283759',
                      '#ee391c',
                      '#283761',
                      '#ee391c',
                      '#283763',
                      '#ee391c',
                      '#283765',
                      '#283766']
            },

            }
        },
        aspectRatio: 2,
        plugins:{
          legend: {
            display: false
         }},
      }
      
    };

    const myChart = new Chart(
      canvas,
      config
    );

    function removeData(chart) {
      chart.data.labels.pop();
      chart.data.datasets.forEach((dataset) => {
        dataset.data.pop();
      });
      chart.update('none');
    }

    function addData(chart, label, newData) {
      chart.data.labels.push(label);
      chart.data.datasets.forEach((dataset) => {
        dataset.data.push(newData);
      });
      chart.update('none');
    }

  </script>
</body>

</html>